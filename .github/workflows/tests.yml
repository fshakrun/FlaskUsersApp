name: Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Run tests with coverage and Allure
        run: |
          pytest \
            --cov=. \
            --cov-report=term-missing \
            --cov-fail-under=90 \
            --alluredir=allure-results

      # ğŸ”¥ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Allure raw results
      - name: ğŸ“¤ Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results
          retention-days: 7

      # ğŸ”¥ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ HTML Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
      - name: ğŸ“Š Generate Allure report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results -o allure-report --clean

      # ğŸ”¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ HTML Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
      - name: ğŸ“¤ Upload Allure report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report
          retention-days: 7